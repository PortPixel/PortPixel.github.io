var cl=console.log,video=document.getElementById("video"),facingMode="environment",constraints={audio:!1,video:{facingMode:facingMode,frameRate:{ideal:60}}};navigator.mediaDevices.getUserMedia(constraints).then(function(a){video.srcObject=a,video.onplaying=function(){processor.doLoad()}});var processor={timerCallback:function(){if(!(this.video.paused||this.video.ended)){this.computeFrame();var a=this;setTimeout(function(){a.timerCallback()},1e3/60)}},doLoad:function(){this.video=document.getElementById("video"),this.c1=document.getElementById("c1"),this.ctx1=this.c1.getContext("2d"),this.c2=document.getElementById("c2"),this.ctx2=this.c2.getContext("2d"),this.backgroundCanvas=document.getElementById("backgroundCanvas"),this.backgroundCtx=this.backgroundCanvas.getContext("2d"),this.c1.className="ARCanvas",this.c2.className="ARCanvas",this.width=this.video.videoWidth,this.height=this.video.videoHeight,this.c1.width=this.width,this.c1.height=this.height,this.c2.width=this.width,this.c2.height=this.height,this.backgroundCanvas.width=this.width,this.backgroundCanvas.height=this.height,cl("loaded"),this.timerCallback()},updateBackgroundCanvas:function(){var a=document.getElementById("backgroundVideo");this.backgroundCtx.drawImage(a,0,0,this.width,this.height)},computeFrame:function(){"none"===curFilter?(this.ctx1.drawImage(this.video,0,0,this.width,this.height),this.ctx2.drawImage(this.video,0,0,this.width,this.height)):"amd2"===curFilter?amd2Filter(this):console.error("filter not known:"+curFilter)}};function amd2Filter(d){d.ctx1.drawImage(d.video,0,0,d.width,d.height);for(var e=d.ctx1.getImageData(0,0,d.width,d.height),f=e.data.length/4,h=d.ctx1.getImageData(0,0,d.width,d.height),j=0;j<f;j++){var k,l,m,n=e.data[4*j+0],o=e.data[4*j+1],g=e.data[4*j+2],b=j%d.width,p=Math.floor(j/d.width),q=Math.max(d.width,d.height),r={x:(b-d.width/2)/q,y:(p-d.height/2)/q},s=255,t={x:0,y:0};for(k=0;k<amdSpots.length&&(l=amdSpots[k],m=getSquareOfDistance(r.x-l.x,r.y-l.y)**l.power,s-=l.size/m,!(0>=s));k++)if(m=getSquareOfDistance(5*((r.x-l.x)/l.size),5*((r.y-l.y)/l.size)),.01>m){var u=getDirection(-r.x+l.x,-r.y+l.y);c++,t.x+=.001*(Math.sin(u)*l.size/m),t.y+=.001*(Math.cos(u)*l.size/m)}if(0>s)s=0;else{var v=b+Math.round(t.x)+(Math.round(t.y)+p)*d.width;e.data[4*j+0]=h.data[4*v+0],e.data[4*j+1]=h.data[4*v+1],e.data[4*j+2]=h.data[4*v+2]}e.data[4*j+3]=s}d.ctx2.putImageData(e,0,0),d.ctx1.putImageData(e,0,0)}function getDirection(a,b){return Math.atan2(a,b)}function getDistance(a,b){return Math.sqrt(Math.pow(a,2)+Math.pow(b,2))}function getSquareOfDistance(a,b){return Math.pow(a,2)+Math.pow(b,2)}function rgbToHsl(a){var e=a.r,f=a.g,i=a.b;e/=255,f/=255,i/=255;var j,k,m=Math.max(e,f,i),n=Math.min(e,f,i),o=(m+n)/2;if(m==n)j=k=0;else{var l=m-n;k=.5<o?l/(2-m-n):l/(m+n);m===e?j=(f-i)/l+(f<i?6:0):m===f?j=(i-e)/l+2:m===i?j=(e-f)/l+4:void 0;j/=6}return{h:j,s:k,l:o}}function hslToRgb(a){var d,e,f,i=a.h,h=a.s,j=a.l;if(0==h)d=e=f=j;else{var k=function(a,b,d){return 0>d&&(d+=1),1<d&&(d-=1),d<1/6?a+6*(b-a)*d:d<1/2?b:d<2/3?a+6*((b-a)*(2/3-d)):a},l=.5>j?j*(1+h):j+h-j*h,m=2*j-l;d=k(m,l,i+1/3),e=k(m,l,i),f=k(m,l,i-1/3)}return{r:Math.round(255*d),g:Math.round(255*e),b:Math.round(255*f)}}var amdSpots=[{x:0,y:0,size:5,power:.5},{x:-.07,y:.15,size:12,power:.5},{x:.15,y:.1,size:8,power:.5}];c=0;var curFilter="amd2",filterNames=["none","amd2"];function cycleThroughToNextFilter(){curFilter=filterNames[(filterNames.indexOf(curFilter)+1)%filterNames.length]}
