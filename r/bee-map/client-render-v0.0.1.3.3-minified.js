"use strict";var ctx,fpsDelta,lastCalledTime,myMap,mouseState=0,cameraX=0,cameraY=0,mouseposx=0,mouseposy=0,centerX=window.innerWidth,centerY=window.innerHeight,zoom=1,frame=0,fps=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],cameraOffsetX=0,cameraOffsetY=0,animationsFrameCounter=0,titlesToRenderRankingFrameCounters={},mouseDownRun=0,mouseDownRunLastFrame=0,enterKeyDownRun=0,enterKeyDownRunLastFrame=0,cells=[],points=[],infoPane={show:!0,mode:0,position:0,speciesShown:"none",speciesShownData:{},savedSearches:[],animation:{savedSearches:{deleteOverHighlightedID:-1}}},storedImages={},curShownPoints=[],speciesCommonNameLookupTable=["Large Red Tailed Bumble Bee","Barbut's Cuckoo Bee","Gypsy (Bohemian) Cuckoo Bee","Field Cuckoo Bee","Great Yellow Bumble Bee","Small Garden Bumble Bee","Brown-banded Carder-bee","Heath Bumble Bee","White-Tailed Bumble Bee","Bilberry (Blaeberry) Bumblebee","Moss Carder-bee","Common Carder Bee","Early Bumble Bee","Red-shanked Carder-bee","Large Garden (Ruderal) Bumblebee","Red-tailed (Hill) Cuckoo Bee","Broken-Belted Bumble Bee","Short-haired Bumble Bee","Shrill Carder Bee","Forest Cuckoo Bee","Buff-Tailed Bumble Bee","Vestal (Southern) Cuckoo Bee"],speciesCommonNameColoursLookupTable=["hsl("+Math.floor(4*(360/22))+", 60%, 50%)","hsl("+Math.floor(7*(360/22))+", 60%, 50%)","hsl("+Math.floor(10*(360/22))+", 60%, 50%)","hsl("+Math.floor(13*(360/22))+", 60%, 50%)","hsl("+Math.floor(16*(360/22))+", 60%, 50%)","hsl("+Math.floor(19*(360/22))+", 60%, 50%)","hsl("+Math.floor(1*(360/22))+", 60%, 50%)","hsl("+Math.floor(5*(360/22))+", 60%, 35%)","hsl("+Math.floor(8*(360/22))+", 60%, 35%)","hsl("+Math.floor(180)+", 60%, 35%)","hsl("+Math.floor(14*(360/22))+", 60%, 35%)","hsl("+Math.floor(17*(360/22))+", 60%, 35%)","hsl("+Math.floor(20*(360/22))+", 60%, 35%)","hsl("+Math.floor(2*(360/22))+", 60%, 35%)","hsl("+Math.floor(6*(360/22))+", 60%, 25%)","hsl("+Math.floor(9*(360/22))+", 60%, 25%)","hsl("+Math.floor(12*(360/22))+", 60%, 25%)","hsl("+Math.floor(15*(360/22))+", 60%, 25%)","hsl("+Math.floor(18*(360/22))+", 60%, 25%)","hsl("+Math.floor(21*(360/22))+", 60%, 25%)","hsl("+Math.floor(3*(360/22))+", 60%, 25%)","hsl("+Math.floor(4*(360/22))+", 60%, 20%)"],options={render:{pointText:{fontSize:20,fadeInStartZoom:18,fadeInEndZoom:19,textRankingMaxTitlesShown:200,textRankingTextFadeInFrames:10,textRankingContinueRunMaxGap:10},cities:{circlePopulationSizeScaling:.007},heatmap:{quality:200,show:!1}},dev:{showPointsRenderPerFrameCounter:!0,showFPS:!0}};if(options.dev.showPointsRenderPerFrameCounter)var pointsRenderedPerFrame=0;var outeriframeFolderUrl,outeriframeRefererUrl=window.location==window.parent.location?document.location.href:document.referrer;outeriframeFolderUrl=outeriframeRefererUrl.endsWith(".html")?outeriframeRefererUrl.substring(0,outeriframeRefererUrl.lastIndexOf("/")):outeriframeRefererUrl,"/"!=outeriframeFolderUrl.slice(-1)&&(outeriframeFolderUrl+="/");var dataFolderURLPath=outeriframeFolderUrl+"data/";console.log(outeriframeFolderUrl),console.log(dataFolderURLPath);function startGame(){gameArea.start()}document.addEventListener("touchmove",function(a){1!==a.scale&&a.preventDefault()},!1);var gameArea={canvas:document.createElement("canvas"),start:function(){this.canvas.width=2*centerX,this.canvas.height=2*centerY,this.canvas.id="canvas",this.context=this.canvas.getContext("2d"),document.body.insertBefore(this.canvas,document.body.childNodes[0]),loadStoredImages();var a=new Mappa("MapboxGL","pk.eyJ1IjoibWFwcGF1c2VyIiwiYSI6ImNqNXNrbXIyZDE2a2cyd3J4Ym53YWxieXgifQ.JENDJqKE1SLISxL3Q_T22w");myMap=a.tileMap({lat:54.43870569035968,lng:-3.0553402410607475,zoom:9.053629548862034,style:"mapbox://styles/mapbox/traffic-night-v2",pitch:50}),myMap.overlay(canvas),myMap.onChange(updateGameArea),this.interval=setInterval(updateGameArea,1e3/60),window.addEventListener("keydown",function(a){gameArea.keys=gameArea.keys||[],gameArea.keys[a.keyCode]="keydown"==a.type}),window.addEventListener("keyup",function(a){gameArea.keys[a.keyCode]="keydown"==a.type})},clear:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}};function drawRotatedRect(a,b,c,d,e,f){ctx=gameArea.context,ctx.save(),ctx.beginPath(),ctx.translate(a,b),ctx.rotate(e*Math.PI/180),ctx.rect(-c/2,-d,c,d),ctx.fillStyle=f,ctx.fill(),ctx.restore()}function drawRotatedImage(a,b,c,d,e,f){ctx.save(),ctx.translate(b,c),ctx.rotate(f*Math.PI/180),ctx.drawImage(a,-(d/2),-(e/2),d,e),ctx.restore()}function drawRotatedNonCenteredImage(a,b,c,d,e,f){ctx.save(),ctx.translate(b,c),ctx.rotate(f*Math.PI/180),ctx.drawImage(a,-(d/2),-e,d,e),ctx.restore()}function toRadians(a){return a*(Math.PI/180)}function toDegrees(a){return a/(Math.PI/180)}function getDirection(a,b){return Math.atan2(a,b)}function getDistance(a,b){return Math.sqrt(Math.pow(a,2)+Math.pow(b,2))}function getSquareOfDistance(a,b){return Math.pow(a,2)+Math.pow(b,2)}function component(a,b,c,d,e){this.gamearea=gameArea,this.width=a,this.height=b,this.speedX=0,this.speedY=0,this.x=d,this.y=e,this.v=0,this.update=function(){drawRotatedRect(cameraX-this.x,cameraY-this.y,this.width,this.height,direction,c)},this.newPos=function(){this.x+=this.speedX,this.y+=this.speedY}}function addNewPoint(a,b,c){points.push({lat:a,lon:b,data:c})}function createNewCell(a,b,c){cells.push({x:a,y:b,size:c})}function checkLatLonIsShownOnScreenAndReturnPixelPosIfSo(a,b,c){c=c||0;var d=myMap.latLngToPixel(a,b);return console.log(0<d.x+c&&d.x-c<canvas.width&&0<d.y+c&&d.y-c<canvas.height),{onScreen:0<d.x+c&&d.x-c<canvas.width&&0<d.y+c&&d.y-c<canvas.height,pixelPos:d}}function checkLatLonIsShownOnMap(a,b){var c=myMap.latLngToPixel(a,b);return 0<c.x&&c.x<canvas.width&&0<c.y&&c.y<canvas.height}function parseSearchString(a,b){if(a=a.trim().toUpperCase(),""==a)return b;var c,d="",e=[],f="";for(c=0;c<a.length;c++)d+=a[c],"AND"==d.substr(-3)?(3===d.length||(""===f?e.push({keyword:"AND",selector:d.substring(0,d.length-3)}):e.push({keyword:f,selector:d.substring(0,d.length-3)})),f="AND",d=""):"OR"==d.substr(-2)&&(" "==a[c-2]&&" "==a[c+1]||0>c-2||c+1>=a.length)?(2===d.length||(""===f?e.push({keyword:"OR",selector:d.substring(0,d.length-2)}):e.push({keyword:"OR",selector:"NOT "+d.substring(0,d.length-2).trim()})),f="OR",d=""):"NOT"==d.substr(-3)&&(2===d.length||(""===f?e.push({keyword:"AND",selector:d.substring(0,d.length-3)}):e.push({keyword:f,selector:d.substring(0,d.length-3)})),f="NOT",d="");for(""===f?e.push({keyword:"AND",selector:d}):e.push({keyword:f,selector:d}),c=0;c<e.length;c++)e[c].selector=e[c].selector.trim(),"AND"===e[c].keyword&&b.allOf.push(e[c].selector),"OR"===e[c].keyword&&b.anyOf.push(e[c].selector),"NOT"===e[c].keyword&&b.noneOf.push(e[c].selector);return b}function testTextAgainstSearchCriteria(a,b){if(0===a.allOf.length&&0===a.noneOf.length&&0===a.anyOf.length)return!0;var c,d,e,f,g={allOf:!0,noneOf:!0,anyOf:!1};for(c=0;c<a.allOf.length;c++)for(e=a.allOf[c].split(" "),d=0;d<e.length;d++)if(!b.includes(e[d])){g.allOf=!1;break}for(c=0;c<a.noneOf.length;c++)for(e=a.noneOf[c].split(" "),d=0;d<e.length;d++)if(b.includes(e[d])){g.noneOf=!1;break}for(0===a.anyOf.length&&(g.anyOf=!0),c=0;c<a.anyOf.length;c++){if(e=a.anyOf[c].split(" "),f=!0,"NOT"==e[0])for(d=0;d<e.length;d++)b.includes(e[d])&&(f=!1);else for(d=0;d<e.length;d++)b.includes(e[d])||(f=!1);f&&(g.anyOf=!0)}return g.allOf&&g.noneOf&&g.anyOf}function genTextForSearchMatchingFromBeeDataPoint(a){return(a.latinName+" "+a.commonName+" "+a.gridRef+" "+a.sampleDate+" "+a.sampleLocation+" "+a.sampleYear+" "+a.collectorName+" "+a.abundance).toUpperCase()}var searchCriteria;function processSearchBox(){searchCriteria={allOf:[],noneOf:[],anyOf:[]},searchCriteria=parseSearchString(document.getElementById("search-box").value,searchCriteria);var a;for(a=0;a<infoPane.savedSearches.length;a++)searchCriteria=parseSearchString(infoPane.savedSearches[a],searchCriteria);for(a=0;a<beeData.length;a++){var b=beeData[a],c=genTextForSearchMatchingFromBeeDataPoint(b);b.showAsMatchesCurrentSearchCriteria=testTextAgainstSearchCriteria(searchCriteria,c)}}function getStatsForCurShownPoints(){var a,b,c=[],d=[];for(a=0;a<curShownPoints.length;a++)b=curShownPoints[a].obj,c.includes(b.commonName)?d[c.indexOf(b.commonName)].count+=1:(c.push(b.commonName),d.push({commonName:b.commonName,count:1}));return d.sort(function(c,a){return a.count-c.count}),{species:c,speciesCount:d}}function getClosestPointToMouse(){var a,b=1/0,c=-1;for(a=0;a<curShownPoints.length;a++)b>Math.pow(mouseposx-curShownPoints[a].x,2)+Math.pow(mouseposy-curShownPoints[a].y,2)&&(c=a,b=Math.pow(mouseposx-curShownPoints[a].x,2)+Math.pow(mouseposy-curShownPoints[a].y,2));return{dist:b,obj:curShownPoints[c]}}function processInfoPaneInteractions(){if(!(0===mouseDownRun&&0<mouseDownRunLastFrame&&10>mouseDownRunLastFrame))0!==infoPane.savedSearches.length&&(mouseposy>.06*canvas.height&&mouseposy<.06*canvas.height+15*1.286*infoPane.savedSearches.length?infoPane.animation.savedSearches.deleteOverHighlightedID=infoPane.savedSearches.length-1-Math.floor((mouseposy-.06*canvas.height)/(15*1.286)):infoPane.animation.savedSearches.deleteOverHighlightedID=-1);else if(!(mouseposx<.8*canvas.width))0!==infoPane.savedSearches.length&&mouseposy>.06*canvas.height&&mouseposy<.06*canvas.height+1.286*15*infoPane.savedSearches.length&&infoPane.savedSearches.splice(infoPane.savedSearches.length-1-Math.floor((mouseposy-.06*canvas.height)/(1.286*15)),1);else if(0<curShownPoints.length){var a=getClosestPointToMouse();a.dist<Math.pow(20,2)&&(infoPane.mode=1,infoPane.speciesShown=a.obj.obj.commonName,infoPane.speciesShownData=a.obj.obj)}if(0===enterKeyDownRun&&0<enterKeyDownRunLastFrame&&20>enterKeyDownRunLastFrame){var b=document.getElementById("search-box").value;0!==b.length&&(infoPane.savedSearches.push(document.getElementById("search-box").value),document.getElementById("search-box").value="")}}function wrapText(a,b,c,d,e,f){var g=a.split(" "),h="",i=1.286*e.substr(0,2);ctx.font=e+" "+f,ctx.textBaseline="top";for(var j=0;j<g.length;j++){var k=h+g[j]+" ",l=ctx.measureText(k),m=l.width;m>d?(ctx.fillText(h,b,c),j<g.length-1?(h=g[j]+" ",c+=i):(h=g[j],c+=i)):h=k}return ctx.fillText(h,b,c),{x:b,y:c,lineHeight:i}}function renderSavedSearches(){var a;if(0<infoPane.savedSearches.length){for(ctx.textAlign="start",ctx.fillStyle="white",a=infoPane.savedSearches.length-1;-1<a;a--){if(infoPane.animation.savedSearches.deleteOverHighlightedID===a&&(ctx.fillStyle="#f66"),a===infoPane.savedSearches.length-1)var b=wrapText(infoPane.savedSearches[infoPane.savedSearches.length-1],.81*canvas.width,.06*canvas.height,999999999,"15px","Arial");else b=wrapText(infoPane.savedSearches[a],b.x,b.y+b.lineHeight,99999999,"15px","Arial");infoPane.animation.savedSearches.deleteOverHighlightedID===a&&(ctx.fillStyle="white")}return b.y+.01*canvas.height}return .01*+canvas.height}function renderInfoPane(){var a,b=getStatsForCurShownPoints();ctx.fillStyle="rgb(100,100,100)",0===infoPane.position&&ctx.fillRect(.8*canvas.width,0,.2*canvas.width+1,canvas.height);var c=renderSavedSearches();if(ctx.textBaseline="alphabetic",0===infoPane.position)for(a=0;5>a&&a<b.speciesCount.length;a++)ctx.fillStyle=speciesCommonNameColoursLookupTable[speciesCommonNameLookupTable.indexOf(b.speciesCount[a].commonName)],0===a?ctx.fillRect(.82*canvas.width,.05*canvas.height+c,.16*canvas.width,.03*canvas.height):ctx.fillRect(.82*canvas.width,canvas.height*(.05+.045*a)+c,.16*canvas.width*b.speciesCount[a].count/b.speciesCount[0].count,.03*canvas.height),ctx.textAlign="start",ctx.fillStyle="white",ctx.font="13px Arial",ctx.fillText(b.speciesCount[a].count+" | "+b.speciesCount[a].commonName,.825*canvas.width,canvas.height*(.07+.045*a)+c);if(c+=canvas.height*(.03+.045*a),1===infoPane.mode&&0===infoPane.position){ctx.textAlign="center",ctx.fillStyle="white";var d=wrapText(infoPane.speciesShown,.9*canvas.width,.05*canvas.height+c,.18*canvas.width,"30px","Arial");d=wrapText(infoPane.speciesShownData.latinName,.9*canvas.width,d.y+d.lineHeight,.18*canvas.width,"15px","Arial"),ctx.drawImage(storedImages[infoPane.speciesShown],.81*canvas.width,d.y+1.5*d.lineHeight,.18*canvas.width,.18*canvas.width/storedImages[infoPane.speciesShown].width*storedImages[infoPane.speciesShown].height),d.y+=.18*canvas.width/storedImages[infoPane.speciesShown].width*storedImages[infoPane.speciesShown].height,d=0!=infoPane.speciesShownData.sampleYear&&"UNKNOWN"!=infoPane.speciesShownData.sampleYear.toUpperCase()?1*infoPane.speciesShownData.sampleYear==infoPane.speciesShownData.sampleYear?wrapText("Sample collected at "+infoPane.speciesShownData.sampleLocation+" in "+infoPane.speciesShownData.sampleYear,.9*canvas.width,d.y+2*d.lineHeight,.18*canvas.width,"15px","Arial"):wrapText("Sample collected at "+infoPane.speciesShownData.sampleLocation+" on "+infoPane.speciesShownData.sampleYear,.9*canvas.width,d.y+2*d.lineHeight,.18*canvas.width,"15px","Arial"):wrapText("Sample collected at "+infoPane.speciesShownData.sampleLocation,.9*canvas.width,d.y+2*d.lineHeight,.18*canvas.width,"15px","Arial")}}function getXHighestOfTextRenderRankingArray(a,b){var c,d,e,f=[];for(c=0;c<b;c++)f.push({importance:-Infinity});for(c=0;c<a.length;c++)for(d=0;d<b;d++)if(a[c].importance>f[d].importance){for(e=b-1;e>d;e--)f[e]=f[e-1];f[d]=a[c];break}return f}function renderHeatMapGetTotalOfSurroundingSquares(a,b,c,d){var e,f,g,h=0;for(e=b-d;e<b+d;e++)for(f=c-d;f<c+d;f++)if(-1<e&&-1<f&&e<a.length&&f<a[0].length)g=Math.pow(Math.pow(b-e,2)+Math.pow(c-f,2),2)+1,h+=a[e][f]/g*myMap.map.getZoom();else;return h}function renderHeatMapForBeeData(a){var b=[myMap.map.unproject([0,0]),myMap.map.unproject([canvas.width,0]),myMap.map.unproject([0,canvas.height]),myMap.map.unproject([canvas.width,canvas.height])],c={min:{lat:b[0].lat,lon:b[0].lng},max:{lat:b[0].lat,lon:b[0].lng}};for(d=1;4>d;d++)b[d].lat<c.min.lat&&(c.min.lat=b[d].lat),b[d].lat>c.max.lat&&(c.max.lat=b[d].lat),b[d].lng<c.min.lon&&(c.min.lon=b[d].lng),b[d].lng>c.max.lon&&(c.max.lon=b[d].lng);var d,e,f,g,h=Math.ceil(canvas.width/a),j=[];for(d=0;d<a;d++)for(j.push([]),e=0;e<Math.ceil(a/canvas.width*canvas.height);e++)j[d].push(0);for(d=0;d<beeData.length;d++)f=beeData[d],f.lat<c.max.lat&&f.lat>c.min.lat&&f.lon<c.max.lon&&f.lon>c.min.lon&&(g=myMap.latLngToPixel(f.lat,f.lon),g.x<canvas.width&&0<=g.x&&g.y<canvas.height&&0<=g.y&&(j[Math.floor(g.x/h)][Math.floor(g.y/h)]+=1));var k;for(d=0;d<j.length;d++)for(e=0;e<j[d].length;e++)k=renderHeatMapGetTotalOfSurroundingSquares(j,d,e,5)/30,.2<k&&(ctx.fillStyle="hsl(188, 100%, "+Math.floor(100*Math.tanh(k))+"%)",ctx.fillRect(h*d,h*e,h,h))}function render(){if(curShownPoints=[],myMap.map){var a=myMap.map.unproject([0,0]),b=myMap.map.unproject([canvas.width,canvas.height]);zoom=1/Math.abs(a.lat-b.lat)}var c;for(c=0;c<cells.length;c++){var d=cells[c];ctx.beginPath(),ctx.arc((cameraX-d.x)*zoom,(cameraY-d.y)*zoom,d.size*zoom/2,0,2*Math.PI,!1),ctx.fillStyle="hsl(360, 100%, 50%)",ctx.fill(),ctx.lineWidth=d.size/10*zoom,ctx.strokeStyle="#003300",ctx.stroke()}if(myMap.map){var e,f,g=[];for(c=0;c<points.length;c++)e=points[c],checkLatLonIsShownOnMap(e.lat,e.lon)&&(f=myMap.latLngToPixel(e.lat,e.lon),ctx.beginPath(),ctx.arc(f.x,f.y,10*zoom/2,0,2*Math.PI,!1),ctx.fillStyle="hsl(360, 100%, 50%)",ctx.fill(),myMap.getZoom()>options.render.pointText.fadeInStartZoom&&(ctx.fillStyle=myMap.getZoom()>options.render.pointText.fadeInEndZoom?"white":"rgba(255,255,255,"+(myMap.getZoom()-options.render.pointText.fadeInStartZoom)/(options.render.pointText.fadeInEndZoom-options.render.pointText.fadeInStartZoom)+")",ctx.textAlign="center",ctx.font=options.render.pointText.fontSize+"px Arial",ctx.fillText(e.data.title,f.x,f.y)));var h=[myMap.map.unproject([0,0]),myMap.map.unproject([canvas.width,0]),myMap.map.unproject([0,canvas.height]),myMap.map.unproject([canvas.width,canvas.height])],j={min:{lat:h[0].lat,lon:h[0].lng},max:{lat:h[0].lat,lon:h[0].lng}};for(c=1;4>c;c++)h[c].lat<j.min.lat&&(j.min.lat=h[c].lat),h[c].lat>j.max.lat&&(j.max.lat=h[c].lat),h[c].lng<j.min.lon&&(j.min.lon=h[c].lng),h[c].lng>j.max.lon&&(j.max.lon=h[c].lng);var k,f,l;for(c=0;c<cities.length;c++)k=cities[c],k[2]<j.max.lat&&k[2]>j.min.lat&&k[3]<j.max.lon&&k[3]>j.min.lon&&(f=myMap.latLngToPixel(k[2],k[3]),options.dev.showPointsRenderPerFrameCounter&&(pointsRenderedPerFrame+=1),ctx.beginPath(),ctx.arc(f.x,f.y,Math.sqrt(k[9])*options.render.cities.circlePopulationSizeScaling*zoom/2,0,2*Math.PI,!1),ctx.fillStyle="hsl(360, 100%, 50%)",ctx.fill(),!1,g.push({x:f.x,y:f.y,rgbBase:"255,255,255",text:k[1],ID:"city"+c,importance:k[9]}));var m,f,l,n=[],o=[];for(c=0;c<beeData.length;c++)m=beeData[c],m.showAsMatchesCurrentSearchCriteria&&m.lat<j.max.lat&&m.lat>j.min.lat&&m.lon<j.max.lon&&m.lon>j.min.lon&&(f=myMap.latLngToPixel(m.lat,m.lon),options.dev.showPointsRenderPerFrameCounter&&(pointsRenderedPerFrame+=1),o.push({x:f.x,y:f.y,size:5,fillStyle:"yellow",renderOutline:!0,outlineWidth:5,outlineStyle:"black"}),curShownPoints.push({x:f.x,y:f.y,obj:m}),n.push([f.x,f.y,1]),!1,!1,myMap.getZoom()>options.render.pointText.fadeInStartZoom&&myMap.getZoom()>options.render.pointText.fadeInEndZoom&&g.push({x:f.x,y:f.y,rgbBase:"255,255,255",text:m.commonName,ID:"bee"+c,importance:1}));heat&&options.render.heatmap.show&&heat.data(n).draw();var p;for(c=0;c<o.length;c++)p=o[c],ctx.beginPath(),ctx.arc(p.x,p.y,p.size,0,2*Math.PI,!1),p.renderOutline&&(ctx.lineWidth=p.outlineWidth,ctx.strokeStyle=p.outlineStyle,ctx.stroke()),ctx.fillStyle=p.fillStyle,ctx.fill();for(g=getXHighestOfTextRenderRankingArray(g,options.render.pointText.textRankingMaxTitlesShown),ctx.textAlign="center",ctx.font=options.render.pointText.fontSize+"px Arial",c=0;c<g.length;c++){var q=g[c];void 0===titlesToRenderRankingFrameCounters[q.ID]?titlesToRenderRankingFrameCounters[q.ID]={frameRun:0,lastFrame:animationsFrameCounter}:titlesToRenderRankingFrameCounters[q.ID].lastFrame+2+options.render.pointText.textRankingContinueRunMaxGap>animationsFrameCounter?(titlesToRenderRankingFrameCounters[q.ID].frameRun+=1,titlesToRenderRankingFrameCounters[q.ID].lastFrame=animationsFrameCounter):(titlesToRenderRankingFrameCounters[q.ID].frameRun=0,titlesToRenderRankingFrameCounters[q.ID].lastFrame=animationsFrameCounter),ctx.fillStyle=titlesToRenderRankingFrameCounters[q.ID].frameRun>options.render.pointText.textRankingTextFadeInFrames?"rgb("+q.rgbBase+")":"rgba("+q.rgbBase+","+titlesToRenderRankingFrameCounters[q.ID].frameRun/options.render.pointText.textRankingTextFadeInFrames+")",ctx.fillText(q.text,q.x,q.y)}processSearchBox(),processInfoPaneInteractions(),renderInfoPane()}}function updateGameArea(){function a(){document.getElementById("canvas").style.left=window.mouseX}function b(){mouseState=1}function c(){mouseState=0}gameArea.clear(),frame+=1,ctx=gameArea.context,1==mouseState?mouseDownRun+=1:mouseDownRun=0,gameArea.keys&&gameArea.keys[13]?enterKeyDownRun+=1:enterKeyDownRun=0;var d=document.getElementById("canvas"),e=d.getContext("2d");document.onmousemove=function(a){var b=a||window.event;window.mouseX=b.clientX,window.mouseY=b.clientY,mouseposx=window.mouseX,mouseposy=window.mouseY},window.onload=function(){setInterval(a,1e3)},document.getElementById("body").onmousedown=function(){b()},document.getElementById("body").onmouseup=function(){c()},gameArea.keys&&gameArea.keys[48]&&(cameraX-=centerX/zoom-centerX/(zoom/1.1),cameraY-=centerY/zoom-centerY/(zoom/1.1),zoom/=1.1),gameArea.keys&&gameArea.keys[57]&&(cameraX-=centerX/zoom-centerX/(1.1*zoom),cameraY-=centerY/zoom-centerY/(1.1*zoom),zoom*=1.1),gameArea.keys&&gameArea.keys[87]&&(cameraOffsetY+=6/zoom),gameArea.keys&&gameArea.keys[83]&&(cameraOffsetY-=6/zoom),gameArea.keys&&gameArea.keys[65]&&(cameraOffsetX+=6/zoom),gameArea.keys&&gameArea.keys[68]&&(cameraOffsetX-=6/zoom),centerX=window.innerWidth/2,centerY=window.innerHeight/2,gameArea.canvas.width=2*centerX,gameArea.canvas.height=2*centerY,cameraX=0+centerX/zoom+cameraOffsetX,cameraY=0+centerY/zoom+cameraOffsetY,options.dev.showPointsRenderPerFrameCounter&&(pointsRenderedPerFrame=0),render(),mouseDownRunLastFrame=mouseDownRun,enterKeyDownRunLastFrame=enterKeyDownRun,fpsDelta=(Date.now()-lastCalledTime)/1e3,lastCalledTime=Date.now(),fps.splice(0,1),fps.push(1/fpsDelta);for(var f=0,g=0;30>g;)f+=fps[g],g++;(options.dev.showFPS||options.dev.showPointsRenderPerFrameCounter)&&(ctx.textAlign="start",ctx.font="30px Arial",ctx.fillStyle="white"),options.dev.showFPS&&ctx.fillText(Math.round(f/30),10,50),options.dev.showPointsRenderPerFrameCounter&&ctx.fillText(pointsRenderedPerFrame,10,80)}function resetCamera(){zoom=1,cameraOffsetX=0,cameraOffsetY=0}var cities=[];function importCitiesData(a){var b,c,d,e,f=a.split("\n"),g=[];for(b=0;b<f.length;b++){for(d=f[b].split("\","),c=0;c<d.length-1;c++)d[c]+="\"";for(e=[],c=0;c<d.length;c++)e.push(JSON.parse(d[c]));""==e[9]?e[9]=0:e[9]*=1,g.push(e)}"city"===g[0][0]&&g.splice(0,1),cities=g}var heat,beeData=[];function runFunctionWhenMapLoads(a,b){myMap&&myMap.map&&myMap.map.loaded()?a():setTimeout(function(){runFunctionWhenMapLoads(a,b)},b)}Papa.parse(dataFolderURLPath+"bee-data/Bumblebee_TH-editted2.csv",{download:!0,complete:function(a){runFunctionWhenMapLoads(function(){importBeeData(a.data,!0)},100)}});function importBeeData(a,b){b===void 0&&(b=!1);var c,d,e,f=[];if(b)g=a;else var g=Papa.parse(a).data;for(c=0;c<g.length;c++)d=g[c],e=2*(Math.random()*Math.PI),f.push({lat:1*d[22]+.001*(Math.random()*Math.sin(e)),lon:1*d[23]+1.5*(.001*(Math.random()*Math.cos(e))),gridRef:d[4],latinName:d[0],commonName:d[1],sampleYear:d[7],sampleDate:d[8],sampleLocation:d[5],showAsMatchesCurrentSearchCriteria:!0,collectorName:d[10],abundance:d[3]});"Latin Name"===f[0].latinName&&f.splice(0,1),beeData=f,heat=simpleheat(gameArea.canvas),heat.radius(15,100)}var storedImagesFileName=["CommonCarderBee.jpg","SmallGardenBumbleBee.jpg","LargeRedTailedBumbleBee.jpg","White-TailedBumbleBee.jpg","Gypsy(Bohemian)CuckooBee.jpg","EarlyBumbleBee.jpg","Buff-TailedBumbleBee.jpg","FieldCuckooBee.jpg","ForestCuckooBee.jpg","Broken-BeltedBumbleBee.jpg","Bilberry(Blaeberry)Bumblebee.jpg","Red-tailed(Hill)CuckooBee.jpg","Vestal(Southern)CuckooBee.jpg","HeathBumbleBee.jpg","BarbutsCuckooBee.jpg","GreatYellowBumbleBee.jpg","Brown-bandedCarder-bee.jpg","MossCarder-bee.jpg","Red-shankedCarder-bee.jpg","LargeGarden(Ruderal)Bumblebee.jpg","Short-hairedBumbleBee.jpg","ShrillCarderBee.jpg"],storedImagesMappedNames=["Common Carder Bee","Small Garden Bumble Bee","Large Red Tailed Bumble Bee","White-Tailed Bumble Bee","Gypsy (Bohemian) Cuckoo Bee","Early Bumble Bee","Buff-Tailed Bumble Bee","Field Cuckoo Bee","Forest Cuckoo Bee","Broken-Belted Bumble Bee","Bilberry (Blaeberry) Bumblebee","Red-tailed (Hill) Cuckoo Bee","Vestal (Southern) Cuckoo Bee","Heath Bumble Bee","Barbut's Cuckoo Bee","Great Yellow Bumble Bee","Brown-banded Carder-bee","Moss Carder-bee","Red-shanked Carder-bee","Large Garden (Ruderal) Bumblebee","Short-haired Bumble Bee","Shrill Carder Bee"];function loadStoredImagesSub(a){var b=new Image;b.onload=function(){storedImages[storedImagesMappedNames[a]]=b},b.src=dataFolderURLPath+"bee-data/images/"+storedImagesFileName[a]}function loadStoredImages(){var a;for(a=0;a<storedImagesFileName.length;a++)loadStoredImagesSub(a)}function addToCreditsBox(){addImageCredits(),addPersonalCredits()}function addPersonalCredits(){var a=document.createElement("a"),b=document.createTextNode(" \u25CF Created by Jack Peck");a.appendChild(b),a.title="Jack Peck",document.getElementsByClassName("mapboxgl-ctrl mapboxgl-ctrl-attrib")[0].appendChild(a)}function addImageCredits(){var a=document.createElement("a"),b=document.createTextNode(" Image Credits");a.appendChild(b),a.title="Image Credits",a.href=outeriframeFolderUrl+"image-credits.html",a.target="_blank",document.getElementsByClassName("mapboxgl-ctrl mapboxgl-ctrl-attrib")[0].appendChild(a)}runFunctionWhenMapLoads(addToCreditsBox,100),setInterval(function(){animationsFrameCounter++},1e3/60);